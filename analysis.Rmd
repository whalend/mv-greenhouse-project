---
title: "Analysis of Plasticity in Microstegium"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: yes
  word_document: null
---

```{r set options, echo=F}

knitr::opts_chunk$set(fig.width = 7.5)
knitr::opts_chunk$set(dpi = 300)
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(warning = F)
knitr::opts_chunk$set(message = F)

options(na.action = "na.fail")# global model setting for using multimodel inference 'dredge' function

```

```{r load libraries}

library(lme4); library(car); library(sciplot); library(lmerTest); 
library(MuMIn)
library(plyr); library(dplyr)
library(ggplot2)
library(knitr)

```

```{r load data}

gh_data <- readxl::read_excel("GH exp data and analysis.xlsx", sheet = 1)

gh_data <- gh_data %>% 
  select(Block:Notes) %>%
  mutate(Light = as.factor(Light), Herbivory = as.factor(Herbivory), 
         Block = as.factor(Block)) %>% 
  rename(pop_lat = `Pop#Lat`, pop_database = `Pop#Database`, 
         first_flower_date = `Date of First Flower`, seeds_per_SH = `Seeds/SH`,
         avg_tiller_length = `Avg. tiller length`, mv_biomass = `Mv biomass`)

# Correct silly duplicate value
gh_data$Lat[gh_data$Lat<33] <- 32.58217
gh_data$Lat <- round(gh_data$Lat, digits = 5)

no_herbivory <- filter(gh_data, Herbivory=="N")

avg_gh_data_no_herb <- no_herbivory %>% 
  group_by(pop_lat, Light) %>% 
  summarise(avg_harvest_date = mean(HarvestOrdDate, na.rm = T),
            avg_flower_date = mean(FlowerOrdDate, na.rm = T),
            avg_seed_mass = mean(AvgSeedMass, na.rm = T),
            avg_tiller_length = mean(avg_tiller_length, na.rm = T),
            avg_seeds_per_sh = mean(seeds_per_SH, na.rm = T),
            avg_mv_biomass = mean(mv_biomass, na.rm = T),
            avg_sla = mean(Avg.SLA, na.rm = T),
            seed_plant_ratio = avg_seed_mass/avg_mv_biomass)

avg_gh_data <- gh_data %>% 
  group_by(Lat, Herbivory, Light) %>% 
  summarise(avg_harvest_date = mean(HarvestOrdDate, na.rm = T),
            avg_flower_date = mean(FlowerOrdDate, na.rm = T),
            avg_seed_mass = mean(AvgSeedMass, na.rm = T),
            avg_tiller_length = mean(avg_tiller_length, na.rm = T),
            avg_seeds_per_sh = mean(seeds_per_SH, na.rm = T),
            avg_mv_biomass = mean(mv_biomass, na.rm = T),
            avg_sla = mean(Avg.SLA, na.rm = T),
            seed_plant_ratio = mean(AvgSeedMass/mv_biomass, na.rm = T))

```

An investigation into phenotypic plasticity of *Microstegium* across a latitudinal gradient with experimental treatments of light and herbivory.


# Methods

Seeds were sourced from 12 populations spanning ~6 degrees of latitude (32.58ยบ to 38.97ยบ) in INSERT CONTINENT/COUNTRY and then grown in a common greenhouse experiment. The greenhouse was arranged into 32 blocks, where each block had every population (12 pots). Each pot was planted with 2-3 seeds. Half of the blocks (16) were manipulated by constructing shade enclosures that decreased light by ~90%, while the other half were exposed to ambient light conditions. Within each light treatment, eight blocks received an herbivory treatment implemented such that each population was equally represented.

The herbivory treatment was initially done using fall army worms (FAW). Overhead leaf area reduced by 13.1% on average before FAW pupation. Because we were interested in a much more significant level of herbivory, we supplemented damage by FAW by removing most of the remaining leaf biomass by hand, resulting in a total reduction of 45.5% overhead leaf area.


# Some notes:

* Abiotic (shade) and biotic (herbivory) treatments were nested

* Herbivory by fall army worm didn't reduce overhead leaf area enough (mean = 13.1%); supplemented to have total reduction of 45.5% overhead leaf area. 
     
    - These are conservative estimates because they don't account for the loss of biomass under the topmost level of vegetation.
    
* 12 latitudes for the populations

We need more detail on the methods, especially the induced herbivory part of the experiment. 

 1. How was the leaf area reduction "supplemented?" 
 
 2. Could the "herbivory" possibly just make it an additional light treatment, e.g. reduction of leaf area without inducing defense mechanisms?


I'm evaluating Kerry's analysis by first repeating what she did using her code, and then making some revisions and embedding figures.


# Building off of analysis by Kerry
Analysis of full data set
Wednesday, August 5, 2015
11:40 PM
 
Data can be found in the "GH exp data and analysis.xlsx" file.

A mixed-effects models were applied to examine the interaction of light and herbivory treatments with the latitude of seedstock origin on date of first flowering, seed production, senescence, tiller length, plant biomass, seed mass, and specific leaf area.

## Model: Date of first flowering

The date of first flowering is ordered by day of year, so larger numbers indicate later in the calendar year.

What is the biological significance of flowering date?

### Day of firest flowering figure
```{r day of first flower prelim figures}

ggplot(gh_data, aes(Lat, FlowerOrdDate, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Day of first flowering") +
  xlab("Latitude")

# ggplot(gh_data, aes(Long, FlowerOrdDate, color = Light)) +
#   geom_point() +
#   scale_color_discrete(h = c(50,110)) +
#   geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
#   # theme_bw() +
#   theme_classic() +
#   ylab("Day of first flowering") +
#   xlab("Longitude")

```

These figures indicate that flowering date is earlier at higher latitudes, and that herbivory and light treatments are not siginificant.

### Day of first flower model
```{r date of first flower model}

# bargraph.CI(Lat, FlowerOrdDate, group = Light, data = filter(gh_data, Herbivory == "N"), legend = T,
#             ylab = "Flower Day", xlab = "Population latitude",
#             err.width = .05, y.leg = 310, ylim = c(245,310))

# summary(gh_data)
gh_data_noNA <- filter(gh_data, is.na(FlowerOrdDate)=="FALSE")

flowering_mod <- lmer(FlowerOrdDate ~ Light*Herbivory*Lat + (1|Block), data=gh_data_noNA)
# qqnorm(residuals(flowering_mod))
# plot(flowering_mod)

Anova(flowering_mod)

step(flowering_mod)# keep block effect
dredge(refitML(flowering_mod)) %>% filter(delta < 7)
```

### Day of first flower: final model
```{r first flower final model}

flowering_mod2 <- lmer(FlowerOrdDate ~ Lat + (1|Block), 
                      data = gh_data_noNA)
summary(flowering_mod2)

# confint(flowering_mod2)

```

Latitude of the origin population was the only signficant explanatory variable for the flowering date response, however, a model that also included the *Light* treatment main effect was equally supported in AIC comparisons. In general, flowering date was earlier for populations from from higher latitudes.

 
## Model: Harvest date (senescence)

1. What is the relationship between harvest date and senescence?

### Senescence (harvest date) figure
```{r senescence prelim figure}

ggplot(gh_data, aes(Lat, HarvestOrdDate, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Day of harvest") +
  xlab("Latitude")

# ggplot(avg_gh_data, 
#        aes(Light, avg_harvest_date, color = as.numeric(Lat))) +
#   # geom_boxplot()+
#   geom_path(aes(group = Lat)) +
#   geom_point(size = 2) +
#   facet_wrap(~Herbivory) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   # ylab("Day of Year") +
#   theme_bw()

# ggplot(gh_data, aes(Lat, HarvestOrdDate, color = Light, shape = Herbivory)) +
#   geom_point() +
#   geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
#   scale_color_discrete(h = c(60,120)) +
#   guides(linetype = guide_legend(override.aes = list(size = .7)),
#              color = guide_legend(override.aes = list(linetype = 0))) +
#   ylab("Day of Year") +
#   theme_bw()

# ggplot(gh_data, aes(Light, HarvestOrdDate, fill = Herbivory)) +
#   geom_boxplot(notch = F) +
#   scale_fill_discrete(h = c(60,120)) +
#   theme_bw()

```

Plotting the raw data suggests that plants sourced from higher latitudes and those in ambient light treatments senesced sooner than those from lower latitudes and in shade treatments.

### Senescence model
```{r senescence model}

# summary(gh_data)
gh_data_noNA <- filter(gh_data, is.na(HarvestOrdDate)=="FALSE")

# gh_data$HarvestOrdDate[is.na(gh_data$HarvestOrdDate)] <- 0

senescence_mod <- lmer(HarvestOrdDate ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)

# qqnorm(residuals(senescence_mod))
plot(senescence_mod)

# Anova(senescence_mod)

```

There was a major outlier that Kerry investigated, but ended up finding an additional outlier. 

>*KS*: I attempted to remove the outlier and re-run the analysis in R using commands, but the results are strange. The row containing the data point causing the anomalous residual is removed, but when the model is re-run, the result is slightly different (but overall same conclusions), but there is a new abnormal residual corresponding to the previous row (which contains data from a different pot). 

It looks like the outlier affects the normality more than the residual variance, so it shouldn't dramatically affect the overall model fit. It could change the estimates a bit. 

**WD:** with my correction (I think) of the data point removed there are no longer major outliers in the residual plots. Based on summary of the data frames for the two models, the observation had no herbivory and was under ambient light conditions.

#### Assess and correct outlier
```{r assess senescence model residual outlier}

which(residuals(senescence_mod) < -40)
# [1] 316 (what KS reported)
## I get 46 (twice for some reason??)

residuals(senescence_mod)[residuals(senescence_mod) < -40]

# summary(senescence_mod@frame)
# gh_data[46,]$HarvestOrdDate

gh_data_noNA <- gh_data_noNA[-46,]
senescence_mod.2 <- lmer(HarvestOrdDate ~ Light*Herbivory*Lat + (1|Block), 
             data = gh_data_noNA) 

# summary(senescence_mod.2@frame)
# plot(senescence_mod.2)
# plot(fitted(senescence_mod.2),residuals(senescence_mod.2))
# qqnorm(residuals(senescence_mod.2))

Anova(senescence_mod.2)
step(senescence_mod.2)# keep block
filter(dredge(refitML(senescence_mod.2)), delta < 7)
```

### Senescence: final model
```{r senescence final model}

senescence_mod.2 <- lmer(HarvestOrdDate ~ Lat + Light + (1|Block), 
                         data = gh_data_noNA)
summary(senescence_mod.2)

# confint(update(senescence_mod.2, . ~ Lat + Light + (1|Block)))[c(-1,-2),]

```

The strongest effects are from latitude and the light treatment, but the model including the interaction between latitude and light is equally supported by the data. Models with the herbivory main effect, or only main effects (no interaction terms), or only latitude, also have some support. Here I reported results from the model with only main effects of latitude and light. At a strict p=.05 level, latitdue is the only significant explanatory variable.


```{r compare plots of senescence_mod and senescence_mod.2 data, eval=F }

senescence_mod_latitude_plot <- ggplot(senescence_mod@frame, aes(Lat, HarvestOrdDate, color = Light)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  geom_point(aes(shape = Herbivory), size = 2) +
  scale_color_discrete(h = c(60,120)) +
  guides(linetype = guide_legend(override.aes = list(size = .7)),
             color = guide_legend(override.aes = list(linetype = 0))) +
  ylab("Day of Year") +
  xlab("Latitude") +
  theme_classic()

senescence_mod.2_latitude_plot <- ggplot(senescence_mod.2@frame, aes(Lat, HarvestOrdDate, color = Light)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  geom_point(aes(shape = Herbivory), size = 2) +
  scale_color_discrete(h = c(60,120)) +
  guides(linetype = guide_legend(override.aes = list(size = .7)),
             color = guide_legend(override.aes = list(linetype = 0))) +
  ylab("Day of Year") +
  xlab("Latitude") +
  theme_classic()

senescence_mod_boxplot <- ggplot(senescence_mod@frame, aes(Light, HarvestOrdDate, fill = Herbivory)) +
  geom_boxplot(notch = F) +
  scale_fill_discrete(h = c(60,120)) +
  ylab("Day of Year") +
  theme_bw()
senescence_mod.2_boxplot <- ggplot(senescence_mod.2@frame, aes(Light, HarvestOrdDate, fill = Herbivory)) +
  geom_boxplot(notch = F) +
  scale_fill_discrete(h = c(60,120)) +
  ylab("Day of Year") +
  theme_bw()

senescence_mod_latitude_plot
senescence_mod.2_latitude_plot +
  ggtitle("outlier observation removed")

senescence_mod_boxplot
senescence_mod.2_boxplot

```

```{r senescence_mod vs senescence_mod.2 models, eval=F}

Anova(senescence_mod)
Anova(senescence_mod.2)

step(senescence_mod)
step(senescence_mod.2)

summary(senescence_mod)
summary(senescence_mod.2)

``` 


## Model: Tiller length

1. How many tillers were measured to calculate the average for each plant?

### Tiller length figure
```{r prelim plots avg tiller length}

ggplot(gh_data, aes(Lat, avg_tiller_length, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Average tiller length (cm)") +
  xlab("Latitude")

# ggplot(gh_data, aes(Light, avg_tiller_length, fill = Herbivory)) +
#   geom_boxplot(notch = T) +
#   scale_fill_discrete(h = c(60,120)) +
#   ylab("Tiller length (cm)") +
#   theme_classic()
  # theme_bw()

# tiller_length <- gh_data %>% 
#   group_by(pop_lat, Light) %>% 
#   summarise(avg_tiller_length = mean(avg_tiller_length, na.rm = T),
#             avg_seed_mass = mean(AvgSeedMass, na.rm = T))

# ggplot(avg_gh_data_light, 
#        aes(Light, avg_tiller_length, color = pop_lat)) +
#   geom_path(aes(group = pop_lat)) +
#   geom_point(size = 2) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   # ylab("Day of Year") +
#   theme_classic()

```


### Tiller length model
```{r avg tiller length model}

gh_data_noNA <- filter(gh_data, is.na(avg_tiller_length)=="FALSE")

tiller_mod <- lmer(avg_tiller_length ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)

# qqnorm(residuals(tiller_mod))
# plot(tiller_mod)
# plot(fitted(tiller_mod),residuals(tiller_mod))
Anova(tiller_mod)
## Anova indicates only the main effects are statistically significant

step(tiller_mod)# keep block
filter(dredge(refitML(tiller_mod)), delta < 7)
## Equal support for main effects only and main effects plus Herb:Light interaction

# # log transformation of average tiller length
# tiller_mod.2<-lmer(log(avg_tiller_length) ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
# qqnorm(residuals(tiller_mod.2))
# plot(tiller_mod.2, main = "log-transformed")
# plot(fitted(tiller_mod.2),residuals(tiller_mod.2))
# summary(tiller_mod.2)
# # Anova(tiller_mod.2)

## square root transformation of average tiller length
# tiller_mod.3<-lmer(sqrt(avg_tiller_length) ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
# qqnorm(residuals(tiller_mod.3))
# plot(tiller_mod.3, main = "square-root transformed")
# summary(tiller_mod.3)
# Anova(tiller_mod.3)

# tiller_mod.1<-lmer(avg_tiller_length ~ Herbivory + Lat*Light + (1|Block), data = gh_data_noNA)
# plot(tiller_mod.1)
# summary(tiller_mod.1)
```

### Tiller length: final model

```{r tiller length final model}

tillermod_2 <- lmer(avg_tiller_length ~ Lat + Light + Herbivory + (1|Block), data = gh_data_noNA)
summary(tillermod_2)
# confint(update(tiller_mod, . ~ Lat + Light + Herbivory + (1|Block)))[c(-1,-2),]

```

Tiller lengths were shorter in populations from higher latitudes. Tillers lengths were also shorter in herbivory treatments, but especially in the shaded herbivory treatment group.


## Model: Plant biomass

Is this aboveground or whole plant (above and below)?

### Plant biomass figure

```{r mv biomass prelim figures}

ggplot(gh_data, aes(Lat, mv_biomass, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Plant biomass (g)") +
  xlab("Latitude")

# ggplot(avg_gh_data, aes(Light, avg_mv_biomass, color = Lat)) +
#   # geom_boxplot()+
#   geom_path(aes(group = Lat)) +
#   geom_point(size = 2) +
#   facet_wrap(~Herbivory) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   # ylab("Day of Year") +
#   theme_bw()

```

Main effects of light and herbivory are apparent (and interaction?), with perhaps a weak main effect of latitude.

### Plant biomass model

```{r mv biomass model}

gh_data_noNA <- filter(gh_data, is.na(mv_biomass)=="FALSE")

mv_biomass_mod <- lmer(mv_biomass ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
# qqnorm(residuals(mv_biomass_mod))
# plot(mv_biomass_mod)
## Major heteroskedacity in the residuals

# hist(log1p(gh_data_noNA$mv_biomass))
# hist(sqrt(gh_data_noNA$mv_biomass))

# plot(update(mv_biomass_mod, log1p(mv_biomass) ~ .), main = "biomass log-transformed")
# plot(update(mv_biomass_mod, sqrt(mv_biomass) ~ .), main = "square-rooted")
## Log transformation results in better residuals

mv_biomass_mod2 <- lmer(log(mv_biomass) ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
Anova(mv_biomass_mod2)
## After transforming response variable only main effects significant

filter(dredge(refitML(mv_biomass_mod2)), delta < 7)

```

I log-transformed the response variable to remove the heteroscedasticity in the residuals seen in the model of the untransformed data.

### Plant biomass: final model

```{r biomass final model}

mv_biomass_mod2 <- lmer(log(mv_biomass) ~ Lat + Light + Herbivory + (1|Block), data = gh_data_noNA)
# plot(mv_biomass_mod2)

summary(mv_biomass_mod2)
# confint(mv_biomass_mod2)[c(-1,-2),]

``` 

```{r log mv biomass figure}

ggplot(gh_data, aes(Lat, log(mv_biomass), color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Log-transformed plant biomass (g)") +
  xlab("Latitude")

```

There was substantial heterskedacity in the residuals of the raw biomass data, so we applied a natural-log transformation to these. The best model had only main effects, but the model also including the Latitude:Light interaction has nearly equal support. Here we report on the model with just the main effects. The light and herbivory had the largest effects, with tiller length greatly reduced by shade and herbivory. Tiller lengths also tended to be shorter in populations that were sourced from higher latitudes.


## Model: Seeds per seed head

1. What does the number of seeds per seed head mean biologically? 

2. Was the number of seeds head counted per plant fixed?

3. What is the biological significance?

### Seeds production figure

```{r plot seeds}

# ggplot(gh_data, aes(Light, seeds_per_SH, fill = Herbivory)) +
#   geom_boxplot(notch = F) +
#   scale_fill_discrete(h = c(120,60)) +
#   theme_bw()

ggplot(gh_data, aes(Lat, seeds_per_SH, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Seeds per seed head") +
  xlab("Latitude")

# ggplot(gh_data, aes(Long, seeds_per_SH, color = Light)) +
#   geom_point() +
#   scale_color_discrete(h = c(50,110)) +
#   geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
#   # theme_bw() +
#   theme_classic() +
#   ylab("Seeds per seed head") +
#   xlab("Longitude")

```

This figure suggests that the herbivory treatment had different effects under ambient and shade conditions, while more seeds were produced per seed head under ambient light conditions. 

* The number of seeds per seed head was lower at higher latitudes, with the exception of the herbivory treatment under ambient light conditions where plants from higher latitudes produced more seeds per seed head. 

    * This exception suggests an interaction between the herbivory treatment and latitude of origin.

* The main effects of herbivory and shade reduced the number of seeds per seed head.

There are `r n_distinct(filter(gh_data, is.na(seeds_per_SH)))` missing values (`NA`) for seeds/seed-head - is this because no seed heads were produced or early plant mortality? It could raise the question of whether these should be treated as true zeroes, i.e. zero seeds were produced, or excluding them as "missing" is the appropriate approach.

I ran models both ways, and using zeroes or excluding these observations as missing has no effect on the overall relationship, but it does change the coefficient estimate for the herbivory effect by seven. I don't think this is a biologically meaningful difference, but it may be more biologically accurate if it is reasonable to think that the light or herbivory treatments may have prevented seeds from being produced. 

These results are with the `NA` values excluded because that's what was done previously.


### Seed production model

```{r seed production model}

gh_data_noNA <- filter(gh_data, is.na(seeds_per_SH)=="FALSE")
# 19 of 384 observations are NA for seeds per seed head 

gh_data$seeds_per_SH[is.na(gh_data$seeds_per_SH)] <- 0

seeds_mod1 <- lmer(seeds_per_SH ~ Light*Herbivory*Lat + (1|Block), data = gh_data)
seeds_mod2 <- lmer(seeds_per_SH ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)

# dredge(refitML(seeds_mod1))
filter(dredge(refitML(seeds_mod2)), delta < 7)

```

### Seed production: final model
```{r seed production final model}

# summary(update(seeds_mod1, . ~ Lat + Herbivory + Light + Herbivory:Lat + (1|Block)))
seeds_mod2 <- lmer(seeds_per_SH ~ Lat + Herbivory + Light + Herbivory:Lat + (1|Block), data = gh_data_noNA)
# plot(seeds_mod2)

summary(seeds_mod2)

# kable(confint.merMod(update(seeds_mod2, . ~ Lat + Herbivory + Light + Herbivory:Lat + (1|Block)))[c(-1, -2),], caption = "95% confidence intervals for coefficient estimates.")

```

The main effects of latitude, herbivory, and light were statistically significant (p < .05, confidence intervals don't overlap zero), as was the interaction between herbivory and latitude.

* Fewer seeds per seed-head were produced by plants from higher latitudes.

    * *The exception of plants in the herbivory treatment that were grown under ambient light conditions is indicated by the siginficant positive effect of the interaction between latitude and herbivory.*
    
* Plants that were grown in the shade or that were in the herbivory treatment also produced fewer seeds per seed head. There was now interaction between the shade and herbivory treatments.

* Plants that were in the shade X herbivory treatment overall produced the fewest seeds per seed head.

 
## Model: Seed mass

1. How was this average seed mass calculated?

2. What is the biological interpretation of this vs. seeds per seed head? How are they different?

### Seed mass figure

```{r seed mass prelim figures}

ggplot(gh_data, aes(Lat, AvgSeedMass, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Average seed mass (g)") +
  xlab("Latitude")

# ggplot(avg_gh_data,
#        aes(Light, avg_seed_mass, color = Lat)) +
#   # geom_boxplot()+
#   geom_path(aes(group = Lat)) +
#   geom_point(size = 2) +
#   facet_wrap(~Herbivory) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   # ylab("Day of Year") +
#   theme_bw()

```

It looks like main effects of latitude and light are likely to be significant, with seed mass lower at higher latitudes, but greater in the shade.

### Seed mass model

```{seed mass model} 

# summary(gh_data)
## 20 missing values (NA)

gh_data_noNA <- filter(gh_data, is.na(AvgSeedMass)=="FALSE")

seed_mass_mod <- lmer(AvgSeedMass ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
# qqnorm(residuals(seed_mass_mod))
plot(seed_mass_mod)

Anova(seed_mass_mod)
## Light, Latitude, Light:Lat interaction significant
step(seed_mass_mod)# keep block
```

### Seed mass: final model

```{r seed mass final model}

gh_data_noNA <- filter(gh_data, is.na(AvgSeedMass)=="FALSE")

seed_mass_mod2 <- lmer(AvgSeedMass ~ Lat + Light + Light:Lat + (1|Block), 
                       data = gh_data_noNA)
# plot(seed_mass_mod2)
summary(seed_mass_mod2)

```
 
Shaded plants had greater average seed mass. Plants originating from higher latitudes had lower average seed mass, and this effect was stronger in the shade treatment.

## Seed mass/plant mass ratio

Drew suggested looking at the seed mass to plant mass ratio (seed mass divided by plant mass)

```{r seed_plant_ratio}

gh_data$seed_plant_mass_ratio <- gh_data$AvgSeedMass/gh_data$mv_biomass

ggplot(gh_data, aes(Lat, seed_plant_mass_ratio, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Seed mass : Plant mass ratio") +
  xlab("Latitude")

# Seed mass:Plant mass ratio
# ggplot(avg_gh_data,
#        aes(Light, seed_plant_ratio, color = Lat)) +
#   # geom_boxplot()+
#   geom_path(aes(group = Lat)) +
#   geom_point(size = 2) +
#   facet_wrap(~Herbivory) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   ylab("Seed mass : Plant mass ratio") +
#   # theme_bw() +
#   theme_classic() +
#   theme(strip.background = element_blank())

```

The herbivory effect is confounded because plant mass was removed. I don't see a way to control for the amount of biomass removed by the herbivory treatment with these data. I didn't run a model for this response.


## Model: Specific leaf area

1. How was average SLA calculated?

### Specific leaf area figure

```{r prelim sla figures}

ggplot(gh_data, aes(Lat, Avg.SLA, color = Light)) +
  geom_point() +
  scale_color_discrete(h = c(50,110)) +
  geom_smooth(aes(linetype = Herbivory), method = "lm", se = F) +
  # theme_bw() +
  theme_classic() +
  ylab("Average SLA") +
  xlab("Latitude")

# ggplot(avg_gh_data, 
#        aes(Light, avg_sla, color = Lat)) +
#   # geom_boxplot()+
#   geom_path(aes(group = Lat)) +
#   geom_point(size = 2) +
#   # geom_smooth(aes(linetype = Light), method = "lm", se = F) +
#   scale_color_continuous(low = "green", high = "brown") +
#   # guides(linetype = guide_legend(override.aes = list(size = .7)),
#              # color = guide_legend(override.aes = list(linetype = 0))) +
#   # ylab("Day of Year") +
#   theme_bw()

```

### SLA model
```{r sla model}

gh_data_noNA <- filter(gh_data, is.na(Avg.SLA)=="FALSE")

sla_mod <- lmer(Avg.SLA ~ Light*Herbivory*Lat + (1|Block), data = gh_data_noNA)
# qqnorm(residuals(sla_mod))
# plot(sla_mod)

Anova(sla_mod)
## Main effects only, no interactions
step(sla_mod)# keep block effect
filter(dredge(refitML(sla_mod)), delta < 7)

## If any of the bars are completely above or below the zero line then the grouping factor account for a significant amount of the variation.
# e <- rstandard(lm(Avg.SLA ~ Light*Herbivory*Lat, data = gh_data_noNA))
# boxplot(e ~ Block, data = gh_data_noNA)
# abline(0,0); axis(2)
```

### SLA: final model

```{r sla final model}

sla_mod2 <- lmer(Avg.SLA ~ Lat + Light + Herbivory + (1|Block), data = gh_data_noNA)
summary(sla_mod2)

``` 

Specific leaf area was lower in plants from higher latitudes, but significantly greater in the shade, and slightly increased by herbivory treatments.
